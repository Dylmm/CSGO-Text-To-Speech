;                                                            ,╓~                     
;                                                      ,╥@╣╣▒▒▒                      
;                                                 ,╓@╬╢╣╣╣╢▒▒▒                       
;                                              ,@╬╣╣╣╣╣╣╣╣▒▒▒`                       
;                                           ,@╣╣╣╣╣╣╣╣╣╣╣▒▒▒┘                        
;                                         ╥╬╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒                         
;                                      ,@╢╣╣╣╣╣╣╣╣╣╣╣╣╢╣▒▒▒                          
;                                    ,╫╢╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒                           
;                                  ,@╢╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒░                           
;                                 g╢╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒                            
;                               ╓╣╣╣╣╣╣╢╣╣╣╣╢╣╣╣╣╣╣╣╢▒▒▒                             
;                              ╟╢╣╣╣╣╣╣╣╣╣▒╢╣╣╣╣╣╣╣╢▒▒▒`                             
;                            ,╬╣╣╣╣╣╣╣╣╣▒▒╢╣╣╣╣╣╣╣╣▒▒▒▒                              
;                           ╓╢╣╣╣╣╣╣╣╣▒▒▒╢╣╣╣╣╣╣╣╣╣▒▒▒                               
;                          ╟╣╣╣╣╣╣╣╣╢▒▒▒▒╣╣╣╣╣╣╣╣╣▒▒▒`                               
;                         ╫╣╣╣╣╣╣╣╣╢▒▒▒\╢╣╣╣╣╣╢╣╣╣▒▒▒                                
;                        ╫╣╣╣╣╣╣╣╣╢▒▒▒ ╫╣╢╣╣╣╣╣╣╢▒▒▒                                 
;                       ╬╣╢╣╣╣╣╣╣╣▒▒▒`]╢╣╣╣╣╣╣╣╣╣▒▒▒                                 
;                      ╫╣╣╣╣╣╣╣╣╣▒▒▒` ╫╣╣╣╣╣╣╣╣╢▒▒▒`²,=╓╥@@@╬╬╬╣╣╣╬@@╖╓              
;                     ╫╣╣╣╣╣╣╣╣╣▒▒▒Ü ,╢╣╣╣╣╣╣╣╣╣╢╢╣╣╢╣╣╣╣╣╣╣╣╣╣╣╣╣╢╢╢╣▒▒▒║╖,  +us     
;                    ║╣╣╣╣╣╣╣╣╣╣▒▒▒  ╟╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╢╢╣▒▒▒▒▒▒▒Ñ╝╜╜╜╙"`          
;                   ╓╣╣╣╣╣╣╣╣╣╣▒▒╢╬╬╢╣╣╣╣╣╣╣╣╣╣╣╣╣╣╢╣▒▒▒▒▒Ñ╜╜"`                      
;                  ╓╢╣╣╣╣╣╣╣╣╣╣╢╣╣╣╣╣╣╣╣╣╣╣╣╣╣╢╣▒▒▒▒Ñ╜╙`                             
;                  ╫╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒"                                   
;                 ╟╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒                                    
;                ]╣╣╣╣╣╣╣╣╣╣╣╣╣╣╣╢╣▒╢╣╣╣╣╣╣╣╣▒▒▒▒                                    
;                ╢╣╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒▒Ñ╫╣╣╣╣╣╢╣╣▒▒▒░                                    
;               ]╣╣╣╣╣╣╣╣╣╣╣▒▒▒▒╜"  ]╣╣╣╣╣╣╣╣▒▒▒`                                    
;               ╢╣╣╣╣╣╣╣╣╣╣╣▒▒▒     ]╣╣╣╣╣╣╣╣▒▒▒                                     
;              ║╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒      ╢╣╣╣╣╣╣╣▒▒▒                                     
;              ╢╣╣╣╣╣╣╣╣╣╣╣▒▒▒▒      ╫╣╣╣╣╣╣╣▒▒▒▒                                    
;             ╓╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒        `╙╨Ñ╣╣╣╣▒▒▒                                    
;             ╙╣╣╣╣╣╣╣╣╣╣╣╣▒▒▒              "╙╜╝▒                                    
;                "╙Ñ╣╣╣╣╣╣╣▒▒▒                                                       
;                     ╙╨╬╢╣▒▒▒                                                       
;                          "╙╜                                                       



; -------------------- CREDITS -------------------------
; Made by AxynoS - youtube.com/c/axynos. Reddit account Axistra(proof in video description.)
; Modified by me and you
; Modify this script to your liking, but give me credit if you do.
; Version 1.0
; -------------------- CREDITS END ---------------------



; -------------------- AHK VERSION ---------------------
;-	Shows the AHK version : Uncomment to check AHK version.
;-	AHK verison must be 1.1 OR ABOVE.
;MsgBox % A_AhkVersion
; -------------------- END AHK VERSION -----------------

; -------------------- INSTRUCTIONS --------------------
;- Start logging csgo with "con_logfile [name].log" in console
;- Change LogFile to the location of the log you created 
;- Set Output, voice and volume to preferred.
; -------------------- INSTRUCTIONS END ----------------

; -------------------- VARIABLES -----------------------
;-	LogFile       				: Constantly updating logfile. Created by the console command con_logfile !tts-axynos
;-	CommandBuffer 				: Extracted commands from log get written to this file
;-	ChatCommand   				: Define the chat command here - anything writter after the = is considered the command
;-	ChatCommandLengthGetter() 	: Gets the command length used to calculate where the actual message is in the line
;-	StartingLine				: Indicates the next line to be read
;-	CurrentLine					: Current line being read
;-	StartupText   				: Text to speak on startup.
;-  TTS 						: TTS engine(Microsoft SAPI)
;-  Volume						; TTS volume
;-  Voice						; TTS Voice
;-  Output						; Indicates which device the TTS will speak through
				
LogFile =  ""					;-  TO YOUR LOG FILE IN THE CSGO FOLDER  |  EXAMPLE: E:\Steam\SteamApps\common\Counter-Strike Global Offensive\csgo\!tts-axynos.log | START MAKING INGAME LOG WITH CONSOLE "con_logfile !tts-axynos.log"
Volume:= 100					;-  FOR VOLUME
Voice:= 0						;-  FOR TTS VOICE,
Output:= 0						;-  FOR DEVICE OUTPUT, SET TO THE DEFAULT IN YOUR SOUNDS SETTING, THE ONE YOU USE FOR CSGO
;- Don't change anything from this point onwards unless you know what you are doing.

CurrentLine = 0
StartingLine = 0
ChatCommand = !tts
ChatCommandLengthGetter()
EnvGet, LocalAppData, LOCALAPPDATA
TTS := ComObjCreate("SAPI.SpVoice")
SetOutputVoiceFormat(TTS, 39,Voice, Volume, Output )
CommandBuffer = %LocalAppData%\csgo_tts\csgottsbuffer.txt
StartupText = <volume level="20">TTS FOR CS:GO, MADE BY AXYNOS. ENJOY!</volume>
; -------------------- VARIABLES END -------------------



; -------------------- STARTUP -------------------------
;-	Deletes current command list. Note that this is separate from the log file in the csgo directory.
IfExist, %CommandBuffer%
	FileDelete, %CommandBuffer%

if LogFile = ""
{
	MsgBox, Log file not specified. Please add in your logfile to the script variables section.
	Exit
}	

If !WinExist("ahk_exe csgo.exe")
	try
	{
	FileDelete, %LogFile%
	FileAppend, , %LogFile%
	}
	catch error
		msgbox % error.what ": " error.message "`nline: " error.line "`nsystem code: " a_lasterror

;-	Comment out the following line if you do not want to listen to the startup voice.
TTS.Speak(StartupText)
; -------------------- STARTUP END ---------------------


;-  TTS COMMAND USAGE CHECKER LOOP
Loop 
{
	;-	Extracts commands from logfile to buffer.
	Loop, read, %LogFile%, %CommandBuffer%
	{
	    IfInString, A_LoopReadLine, %ChatCommand%, FileAppend, %A_LoopReadLine%`n
	}



	Loop, read, %CommandBuffer%
	{
		FileReadLine, ThisLineOutput, %CommandBuffer%, CurrentLine
		;IfInString, ThisLineOutput, %ChatCommand%
		;{
			;-	Tells the script that we want to use a global variable
			global ChatCommandLength
			global StartingLine
			global CurrentLine

			last_line = 0
			Loop, read, %CommandBuffer%
    			last_line++
    		;MsgBox, %last_line%

			;-	Gets the entire unmodified chat message length.
			StringLen, lineLength, ThisLineOutput
			;MsgBox, %lineLength% - length

			;-	Gets command position and skips it, so it doesn't get included in the TTS message.
			StringGetPos, cmdPos, ThisLineOutput, %ChatCommand%
			MessageStartPos = %cmdPos%
			MessageStartPos += %ChatCommandLength%
			MessagePos = %lineLength%
			MessagePos -= %MessageStartPos% ;- Gets actual TTS message start position

			;- Gets actual TTS message to be played out
			StringRight, Message, ThisLineOutput, %MessagePos%
			;- Plays TTS
			if CurrentLine <= %last_line%
			{
				TTS.Speak(Message)
				CurrentLine++
			}


		;}
	}



	IfExist, %CommandBuffer%
	{
		FileDelete, %CommandBuffer%
		;FileDelete, %LogFile%
	}

	;- Wait before relooping, time in milliseconds.
	Sleep, 100
} ;-  LOOP END
; -------------------- LOOPS END -----------------------

; -------------------- FUNCTIONS -----------------------
;-	SAPI TTS format
SetOutputVoiceFormat(TTS, AudioOutputStreamFormatType, Voice, Volume, Output) {
	TTS.AllowAudioOutputFormatChangesOnNextSet:=0
	TTS.AudioOutputStream.Format.Type:=AudioOutputStreamFormatType
	TTS.AudioOutputStream:=TTS.AudioOutputStream
	
	
	;-	Set AudioOutputs
	TTS.AudioOutput:=TTS.GetAudioOutputs.Item(Output)
	
	;- 	Show List of AudioOutputs, including active 
	Loop % TTS.GetAudioOutputs.count
	{
		if A_Index-1=Output
		{
		
		vOutput .= A_Index-1 ": " "->" TTS.GetAudioOutputs.Item(A_Index-1).GetDescription
		vOutput .= ". `n"
		}
		else
		{
			vOutput .= A_Index-1 ": " TTS.GetAudioOutputs.Item(A_Index-1).GetDescription
			vOutput .= ". `n"
		}
	}
	MsgBox, AudioOutput: `n%vOutput%
	
	;-	Set Voice
	TTS.Voice:=TTS.GetVoices().Item(Voice)
	
	;-	Show List of Voice, including active 
	Loop % TTS.GetVoices().count 
	{
		if A_Index-1=Voice
		{
		vVoices .= A_Index-1 ": " "->" TTS.GetVoices.Item(A_Index-1).GetDescription 
		vVoices .= ". `n"
		}
		else
		{
			vVoices .= A_Index-1 ": " TTS.GetVoices.Item(A_Index-1).GetDescription 
			vVoices .= ". `n"
		}
	
	}
	MsgBox Voice: `n%vVoices%

	TTS.AllowAudioOutputFormatChangesOnNextSet:=1
	TTS.Volume:= Volume
}

;-	Returns command length, used for message separation.
ChatCommandLengthGetter() {
	global ChatCommand
	StringLen, ChatCommandLength, ChatCommand
}
; -------------------- FUNCTIONS END -------------------
